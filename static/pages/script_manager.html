<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>Schedule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <link rel="shortcut icon" href="../assets/img/favicon.ico"/>
    <!-- Loading Bootstrap -->
    <link href="../assets/css/backend.min.css" rel="stylesheet">
    <!--<link href="assets/css/bootstrap.css" rel="stylesheet">-->

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
    <script src="../assets/js/html5shiv.js"></script>
    <script src="../assets/js/respond.min.js"></script>
    <![endif]-->
    <script src="../assets/js/jquery-3.2.1.min.js"></script>
    <script src="../assets/js/bootstrap-3.3.7.min.js"></script>
    <script src="../assets/js/jquery.dataTables.min.js"></script>
    <script src="../assets/js/dataTables.bootstrap.min.js"></script>
    <style type="text/css">
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            .form-control.input-sm {
                padding: 0px 20px 5px 10px;
            }
        }

        .dataTables_filter {
            display: none;
        }
    </style>
</head>

<body class="inside-header inside-aside ">
<div id="main" role="main">
    <div class="tab-content tab-addtabs">
        <div id="content">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <section class="content-header hide">
                        <h1> Dashboard
                            <small>Control panel</small>
                        </h1>
                    </section>
                    <!-- RIBBON -->
                    <div id="ribbon">
                        <ol class="breadcrumb pull-left">
                            <li><a href="dashboard" class="addtabsit"><i class="fa fa-dashboard"></i> Dashboard</a></li>
                        </ol>
                        <ol class="breadcrumb pull-right">
                            <li><a href="javascript:;" data-url="page.html">Script Manager</a></li>
                        </ol>
                    </div>
                    <!-- END RIBBON -->
                    <div class="content">
                        <div class="panel panel-default panel-intro">
                            <div class="panel-body">
                                <div id="myTabContent" class="tab-content">
                                    <div class="tab-pane fade active in" id="one">
                                        <div class="col-lg-12 col-md-12">
                                            <div class="pannel pannel-primary">
                                                <div class="pannel-heading">
                                                    <div class="panel-title"><h3>Script Manager</h3></div>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="fixed-table-toolbar">
                                                            <div class="pull-right search">
                                                                <form class="form-inline">
                                                                    <div class="form-group">
                                                                        <label class="title">Search </label>
                                                                        <input class="form-control"
                                                                               type="text"
                                                                               id="file_search"
                                                                               placeholder="Search">
                                                                    </div>
                                                                </form>
                                                            </div>
                                                            <div class="bs-bars pull-left">
                                                                <div id="toolbar" class="toolbar">
                                                                    <iframe name="juniper_iframe"
                                                                            style="display:none;"></iframe>
                                                                    <form class="form-inline" role="form"
                                                                          target="juiper_ifame"
                                                                          onsubmit="return false;">
                                                                        <div class="form-group">
                                                                            <label>Repository Name</label>
                                                                            <select class="form-control"
                                                                                    id="repos"></select>
                                                                        </div>
                                                                        <div class="form-group">
                                                                            <label>Branch</label>
                                                                            <select class="form-control"
                                                                                    id="branch"></select>
                                                                        </div>
                                                                        <div class="form-group">
                                                                            <button class="btn btn-success"
                                                                                    onclick="init_add_file_modal()">Add
                                                                            </button>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <br>
                                                        <div class="row">
                                                            <table id="file_list"
                                                                   class="table table-striped table-bordered table-hover"
                                                                   width="100%">
                                                                <thead>
                                                                <tr>
                                                                    <th>File Path</th>
                                                                    <th>Name</th>
                                                                    <th>Type</th>
                                                                </tr>
                                                                </thead>
                                                            </table>
                                                        </div>

                                                        <!-- Add Files（Modal） -->
                                                        <div class="modal fade" id="modal_add_file" tabindex="-1"
                                                             role="dialog"
                                                             aria-labelledby="myModalLabel" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="close"
                                                                                data-dismiss="modal" aria-hidden="true">
                                                                            &times;
                                                                        </button>
                                                                        <h4 class="modal-title">File Add</h4>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <iframe name="file_add_iframe"
                                                                                style="display:none;"></iframe>
                                                                        <form class="form" role="form"
                                                                              target="file_add_iframe"
                                                                              onsubmit="return false;">
                                                                            <div class="form-group">
                                                                                <label>Repository</label>
                                                                                <input class="form-control"
                                                                                       id="add_modal_repos_name"
                                                                                       readonly="readonly"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>Branch</label>
                                                                                <input class="form-control"
                                                                                       id="add_modal_branch"
                                                                                       readonly="readonly"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>File Path</label>
                                                                                <select class="form-control"
                                                                                        id="add_modal_file_path"></select>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>File Name</label>
                                                                                <input class="form-control"
                                                                                       id="add_modal_file_name"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>Commit Message</label>
                                                                                <input class="form-control"
                                                                                       id="add_modal_commit_message"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>File Content</label>
                                                                                <textarea
                                                                                        style="max-width:500px;min-height:200px;;"
                                                                                        class="form-control"
                                                                                        id="add_modal_file_content"></textarea>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-default"
                                                                                data-dismiss="modal">Close
                                                                        </button>
                                                                        <button type="button" class="btn btn-primary"
                                                                                onclick="add_file()">Add
                                                                        </button>
                                                                    </div>
                                                                </div><!-- /.modal-content -->
                                                            </div><!-- /.modal -->
                                                        </div>

                                                        <!-- Update Files（Modal） -->
                                                        <div class="modal fade" id="modal_update_file" tabindex="-1"
                                                             role="dialog"
                                                             aria-labelledby="myModalLabel" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="close"
                                                                                data-dismiss="modal" aria-hidden="true">
                                                                            &times;
                                                                        </button>
                                                                        <h4 class="modal-title">
                                                                            File Edit</h4>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <iframe name="file_edit_iframe"
                                                                                style="display:none;"></iframe>
                                                                        <form class="form" role="form"
                                                                              target="file_edit_iframe"
                                                                              onsubmit="return false;">
                                                                            <div class="form-group">
                                                                                <label>Repository</label>
                                                                                <input class="form-control"
                                                                                       id="update_modal_repos_name"
                                                                                       readonly="readonly"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>Branch</label>
                                                                                <input class="form-control"
                                                                                       id="update_modal_branch"
                                                                                       readonly="readonly"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>File ID</label>
                                                                                <input class="form-control"
                                                                                       id="update_modal_file_id"
                                                                                       readonly="readonly"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>File Name</label>
                                                                                <input class="form-control"
                                                                                       id="update_modal_file_name"
                                                                                       readonly="readonly"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>Commit Message</label>
                                                                                <input class="form-control"
                                                                                       id="update_modal_commit_message"/>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label>File Content</label>
                                                                                <textarea
                                                                                        style="max-width:500px;min-height:200px;"
                                                                                        class="form-control"
                                                                                        id="update_modal_file_content"></textarea>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" style="float: left"
                                                                                class="btn btn-danger"
                                                                                data-dismiss="modal"
                                                                                onclick="delete_file()">Delete
                                                                        </button>
                                                                        <button type="button" class="btn btn-default"
                                                                                data-dismiss="modal">Close
                                                                        </button>
                                                                        <button type="button" class="btn btn-primary"
                                                                                onclick="update_file()">Update
                                                                        </button>
                                                                    </div>
                                                                </div><!-- /.modal-content -->
                                                            </div><!-- /.modal -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/js/gitlab.js"></script>
<script type="text/javascript">
    var table_data_url = "";
    $(document).ready(function () {
        //Get Repository
        GetRepository($("#repos"));

        // Get Repository Branches
        $("#repos").change(function () {
            var repos = $("#repos option:selected");
            if (repos.val() != 0) {
                GetBranch($("#branch"), repos.text());
            }
        });
        // Get Branch File List
        $("#branch").change(function () {
            var branch = $("#branch option:selected");
            if (branch.val() != 0) {
                table_data_url = "/v1.0.0/gitlab/repository/tree?repos_name=" + $("#repos option:selected").text() +
                    "&branch=" + branch.text();
                list_files(table_data_url);
            }
        });

        // Init Add File Modal
        $("#modal_add_file").on("shown.bs.modal", function () {
            $("#add_modal_file_name").val("");
            $("#add_modal_file_content").val("");
            $("#add_modal_file_path").empty();

            GetBranchTree($("#add_modal_repos_name").val(),$("#add_modal_branch").val(),$("#add_modal_file_path"));
        });

        // Init Update File Modal
        $("#modal_update_file").on("shown.bs.modal", function () {

            GetFileContent($("#update_modal_repos_name").val(),$("#update_modal_file_id").val(), $("#update_modal_file_content"));
        });
    });

    function init_add_file_modal() {
        $("#add_modal_repos_name").val($("#repos option:selected").text());
        $("#add_modal_branch").val($("#branch option:selected").text());
        $("#modal_add_file").modal("show");
    }

    function add_file() {
        var project_name = $("#add_modal_repos_name").val();
        var file_path = $("#add_modal_file_path option:selected");
        var branch = $("#add_modal_branch").val();
        var commit_message = $("#add_modal_commit_message").val();
        var file_name = $("#add_modal_file_name").val();
        var file_content = $("#add_modal_file_content").val();

        if (file_path.val() != -1) {
            file_name = file_path.text() + "/" + file_name;
        }
        var add_json = JSON.stringify({
            "repos_name": project_name,
            "branch":branch,
            "commit_message": commit_message,
            "file_name": file_name,
            "file_content": file_content
        });
        $.ajax({
            type: "POST",
            url: "/v1.0.0/gitlab/repository/commits",
            data: add_json,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.status == 0) {
                    $("#modal_add_file").modal('hide');
                    list_files(table_data_url);
                } else {
                    alert(data.msg);
                }
            }
        });
    }

    function update_file() {
        var project_name = $("#update_modal_repos_name").val();
        var file_name = $("#update_modal_file_name").val();
        var branch = $("#update_modal_branch").val();
        var commit_message = $("#update_modal_commit_message").val();
        var file_content = $("#update_modal_file_content").val();

        var update_json = JSON.stringify({
            "repos_name": project_name,
            "branch":branch,
            "commit_message": commit_message,
            "file_name": file_name,
            "file_content": file_content
        });
        $.ajax({
            type: "PATCH",
            url: "/v1.0.0/gitlab/repository/commits",
            data: update_json,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.status == 0) {
                    $("#modal_update_file").modal('hide');
                    list_files(table_data_url);
                } else {
                    alert(data.msg);
                }
            }
        });
    }

    function delete_file() {
        var project_name = $("#update_modal_repos_name").val();
        var branch = $("#update_modal_branch").val();
        var file_name = $("#update_modal_file_name").val();

        $.ajax({
            type: "DELETE",
            url: "/v1.0.0/gitlab/repository/commits?repos_name=" + project_name + "&file_name=" + file_name +"&branch=" + branch,
            success: function (data) {
                if (data.status == 0) {
                    $("#modal_update_file").modal("hide");
                    list_files(table_data_url);
                } else {
                    alert(data.msg);
                }
            }
        });
    }

    function list_files(url) {
        var table = $('#file_list');
        table.dataTable().fnDestroy();
        table.dataTable({
            PaginationType: "full_numbers",
            lengthMenu: [[20, 40, 60, -1], [20, 40, 60, "All"]],
            columnDefs: [{
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            }],
            select: true,
            sort: true,
            processing: true,
            serverSide: false,
            paging: true,
            lengthChange: true,
            searching: true,
            ordering: true,
            order: [[0, "asc"]],
            info: true,
            autoWidth: false,
            dataType: 'json',
            contentType: "application/json;charset=utf-8",
            ajax: {
                url: url
            },
            columns: [
                {"data": "path"},
                {"data": "name"},
                {"data": "type"}
            ]
        });
        $("#file_search").on("keyup click", function () {
            $("#file_list").DataTable().search(
                $("#file_search").val()
            ).draw();
        });
        // Table Selected
        $('#file_list tbody').on("click", "tr", function () {
            if ($(this).hasClass("selected")) {
                $(this).removeClass("selected");
            }
            else {
                table.$("tr.selected").removeClass("selected");
                $(this).addClass("selected");

                var file_id = "";
                var file_name = "";
                var file_type = "";
                var nTrs = table.dataTable().fnGetNodes();//fnGetNodes获取表格所有行，nTrs[i]表示第i行tr
                for (var i = 0; i < nTrs.length; i++) {
                    if ($(nTrs[i]).hasClass("selected")) {
                        var t = table.dataTable().fnGetData(nTrs[i]);
                        file_id = t["id"];
                        file_name = t["path"];
                        file_type = t["type"];
                        break;
                    }
                }
                if (file_type == "blob") {
                    $("#update_modal_repos_name").val($("#repos option:selected").text());
                    $("#update_modal_branch").val($("#branch option:selected").text());
                    $("#update_modal_file_id").val(file_id);
                    $("#update_modal_file_name").val(file_name);
                    $("#modal_update_file").modal("show");
                } else {
                    alert("It's a directory");
                }
            }
        });
    }
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>Schedule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <link rel="shortcut icon" href="assets/img/favicon.ico"/>
    <!-- Loading Bootstrap -->
    <link href="assets/css/backend.min.css" rel="stylesheet">
    <!--<link href="assets/css/bootstrap.css" rel="stylesheet">-->

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements. All other JS at the end of file. -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->
    <script src="assets/js/jquery-3.2.1.min.js"></script>
    <script src="assets/js/bootstrap-3.3.7.min.js"></script>
    <script src="assets/js/jquery.dataTables.min.js"></script>
    <script src="assets/js/dataTables.bootstrap.min.js"></script>

    <!--select -->
    <link rel="stylesheet" type="text/css" href="assets/css/multi-select.css">
    <script src="assets/js/jquery.multi-select.js"></script>
    <style type="text/css">
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            .form-control.input-sm {
                padding: 0px 20px 5px 10px;
            }
        }

        .dataTables_filter {
            display: none;
        }


    </style>
</head>

<body class="inside-header inside-aside ">
<div id="main" role="main">
    <div class="tab-content tab-addtabs">
        <div id="content">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <section class="content-header hide">
                        <h1> Dashboard
                            <small>Control panel</small>
                        </h1>
                    </section>
                    <!-- RIBBON -->
                    <div id="ribbon">
                        <ol class="breadcrumb pull-left">
                            <li><a href="dashboard" class="addtabsit"><i class="fa fa-dashboard"></i> Dashboard</a></li>
                        </ol>
                        <ol class="breadcrumb pull-right">
                            <li><a href="javascript:;" data-url="page.html">Schedule</a></li>
                        </ol>
                    </div>
                    <!-- END RIBBON -->
                    <div class="content">
                        <div class="panel panel-default panel-intro">

                            <div class="panel-body">
                                <div id="myTabContent" class="tab-content">
                                    <div class="tab-pane fade active in" id="one">
                                        <div class="col-lg-12 col-md-12">
                                            <div class="pannel pannel-primary">
                                                <div class="pannel-heading">
                                                    <div class="panel-title"><h3>Schedule</h3></div>
                                                </div>
                                                <div class="panel-body">
                                                    <div class="row" id="add_schedule_field">
                                                        <div class="col-lg-6, col-md-6">
                                                            <form class="form-horizontal" role="form"
                                                                  onsubmit="return false;">
                                                                <div class="form-group">
                                                                    <label>Device Type</label>
                                                                    <select class="form-control" id="device_type">
                                                                    </select>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Host</label>
                                                                    <select class="form-control" id="host"
                                                                            multiple="multiple">
                                                                    </select>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>User Name</label>
                                                                    <input type="text" class="form-control"
                                                                           id="name"
                                                                           placeholder="User Name">
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Password</label>
                                                                    <input type="password" class="form-control"
                                                                           id="password"
                                                                           placeholder="User Password">
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Repository Name</label>
                                                                    <select class="form-control"
                                                                            id="repos"></select>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Branch</label>
                                                                    <select class="form-control"
                                                                            id="branch"></select>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Execute File</label>
                                                                    <select class="form-control" id="file"></select>
                                                                </div>
                                                                <div class="form-group" id="div_add_module">
                                                                    <label>Model</label>
                                                                    <select id="add_module"
                                                                            class="form-control">
                                                                    </select>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Schedule Name</label>
                                                                    <input type="text" class="form-control"
                                                                           id="add_schedule_name"
                                                                           placeholder="Schedule Name"
                                                                    >
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Cron Time</label>
                                                                    <input type="text" class="form-control"
                                                                           id="add_cron_time"
                                                                           placeholder="Cron Time" data-toggle="popover"
                                                                           data-placement="top"
                                                                    >
                                                                </div>
                                                                <div class="form-group">
                                                                    <button class="btn btn-success"
                                                                            onclick="add_schedule()">Submit
                                                                    </button>
                                                                    <button class="btn btn-danger"
                                                                            onclick="hide_field()">Cancel
                                                                    </button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="col-lg-6 col-md-6">
                                                       <textarea
                                                               style="max-width:500px;max-height:840px;min-height: 840px;min-width: 300px"
                                                               id="script" readonly="readonly"></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="fixed-table-toolbar">
                                                            <div class="pull-right search">
                                                                <form class="form-inline">
                                                                    <div class="form-group">
                                                                        <label class="title">Search </label>
                                                                        <input class="form-control"
                                                                               type="text"
                                                                               id="schedule_search"
                                                                               placeholder="Search">
                                                                    </div>
                                                                </form>
                                                            </div>
                                                            <div class="bs-bars pull-left">
                                                                <div id="toolbar" class="toolbar">
                                                                    <button class="btn btn-primary btn-refresh"
                                                                            onclick="refresh()"><i
                                                                            class="fa fa-refresh"></i></button>
                                                                    <button class="btn btn-success btn-add"
                                                                            onclick="show_add_schedule()"><i
                                                                            class="fa fa-plus"></i> Add
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <div class="row">
                                                        <table id="schedules_table"
                                                               class="table table-bordered"
                                                               width="100%">
                                                            <thead>
                                                            <tr>
                                                                <th>IP</th>
                                                                <th>Schedule Name</th>
                                                                <th>Device Type</th>
                                                                <th>Script Name</th>
                                                                <th>Last Run Time</th>
                                                                <th>Success</th>
                                                                <th>Cron Time</th>
                                                                <th>Enable</th>
                                                            </tr>
                                                            </thead>
                                                        </table>
                                                    </div>

                                                    <!-- Update Schedule（Modal） -->
                                                    <div class="modal fade" id="modal_update_schedule" tabindex="-1"
                                                         role="dialog"
                                                         aria-labelledby="myModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <button type="button" class="close"
                                                                            data-dismiss="modal" aria-hidden="true">
                                                                        &times;
                                                                    </button>
                                                                    <h4 class="modal-title">
                                                                        Schedule Edit</h4>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form class="form" role="form">
                                                                        <div class="form-group">
                                                                            <label>Schedule ID</label>
                                                                            <input type="text" class="form-control"
                                                                                   id="update_schedule_id"
                                                                                   readonly="readonly">
                                                                        </div>
                                                                        <div class="form-group">
                                                                            <label>User Name</label>
                                                                            <input type="text" class="form-control"
                                                                                   id="update_user_name"
                                                                                   placeholder="User Name">
                                                                        </div>
                                                                        <div class="form-group">
                                                                            <label>User Password</label>
                                                                            <input type="password" class="form-control"
                                                                                   id="update_user_password"
                                                                                   placeholder="User Password">
                                                                        </div>
                                                                        <div class="form-group">
                                                                            <label>Cron Time</label>
                                                                            <input type="text" class="form-control"
                                                                                   id="update_cron_time"
                                                                                   placeholder="Cron Time"
                                                                                   data-toggle="popover"
                                                                                   data-placement="top"
                                                                            >
                                                                        </div>
                                                                        <div class="form-group">
                                                                            <label>Enable This Schedule</label>
                                                                            <select id="update_enabled"
                                                                                    class="form-control">
                                                                                <option value="enabled">
                                                                                    Enable
                                                                                </option>
                                                                                <option value="disabled">Disable
                                                                                </option>
                                                                            </select>
                                                                        </div>
                                                                    </form>
                                                                    <div class="row">
                                                                        <table id="schedule_table"
                                                                               class="table table-bordered"
                                                                               width="100%">
                                                                            <thead>
                                                                            <tr>
                                                                                <th>Last Run Time</th>
                                                                                <th>Next Run Time</th>
                                                                                <th>Success</th>
                                                                            </tr>
                                                                            </thead>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" style="float: left"
                                                                            class="btn btn-danger"
                                                                            data-dismiss="modal"
                                                                            onclick="delete_schedule()">Delete
                                                                    </button>
                                                                    <button type="button" class="btn btn-default"
                                                                            data-dismiss="modal">Close
                                                                    </button>
                                                                    <button type="button" class="btn btn-primary"
                                                                            onclick="update_schedule()">Update
                                                                    </button>
                                                                </div>
                                                            </div><!-- /.modal-content -->
                                                        </div><!-- /.modal -->
                                                    </div>
                                                    <!-- History Modal-->
                                                    <div class="modal fade" id="modal_schedule_history" tabindex="-1"
                                                         role="dialog"
                                                         aria-labelledby="myModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <button type="button" class="close"
                                                                            data-dismiss="modal" aria-hidden="true">
                                                                        &times;
                                                                    </button>
                                                                    <h4 class="modal-title">
                                                                        Schedule History</h4>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form class="form" role="form">
                                                                        <div class="form-group">
                                                                            <textarea
                                                                                    style="max-width:500px;max-height:400px;min-height: 400px;min-width: 500px"
                                                                                    id="history"
                                                                                    readonly="readonly"></textarea>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-default"
                                                                            data-dismiss="modal">Close
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div><!-- /.modal-content -->
                                                    </div><!-- /.modal -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
</div>
</div>
<script src="assets/js/gitlab.js"></script>
<script type="text/javascript">
    var update_schedule_id = "";
    var update_device_ip = "";
    var update_repos_name = "";
    var update_branch = "";
    var update_file_path = "";
    var update_schedule_type = "";
    var update_schedule_name = "";
    var update_schedule_module = "";
    var update_enabled = "";

    $(document).ready(function () {
        hide_field();
        format_schedules_table();
        $("#schedule_search").on("keyup click", function () {
            $('#schedules_table').DataTable().search(
                $('#schedule_search').val()
            ).draw();
        });

        // Init Update Schedule Modal
        $("#modal_update_schedule").on("shown.bs.modal", function () {
            format_schedule_table("/api/v1/schedules/history?format=table&schedule_id=" + $("#update_schedule_id").val());

        });


        // Get Repository Branches
        $("#repos").change(function () {
            var repos = $("#repos option:selected");
            if (repos.val() != 0) {
                GetBranch($("#branch"), repos.text());
            }
        });
        // Get Branch File List
        $("#branch").change(function () {
            GetFileList($("#repos option:selected").text(), $("#branch option:selected").text(),$("#file"))

        });


        // Script Content
        $("#file").change(function () {
            GetFileContent($("#repos option:selected").text(), $("#file option:selected").val(),$("#script"));
        });
    });

    function hide_field() {
        $("#add_schedule_field").hide();
    }

    function refresh() {
        format_schedules_table();
    }

    $("#device_type").change(function () {

        get_hosts($("#device_type option:selected").text());

        var module_select = $("#add_module");
        module_select.empty();
        module_select.append("<option selected='selected'  value=-1>Select Module</option>");
        if ($("#device_type option:selected").text() != "linux") {
            module_select.append("<option value='config'>config</option>");
            module_select.append("<option value='query'>query</option>");
        } else {
            module_select.append("<option value='shell'>shell</option>");
        }
    });


    // Cron time tip
    $("[data-toggle='popover']").popover({
        trigger: "focus",
        html: true,
        title: "Cron Time Tips",
        content: "<b>Cron time format</b><br>second minute hour day month year</br>" +
        "<b>Per minute</b></br>0 */1 * * * * or 0 */1<br>" +
        "<b>Per hour</b><br>0 0 * * * *or 0 <br>" +
        "<b>3-8 hour per day</b><br>0 0 3-8 * * * or 0 0 3-8<br>" +
        "<b>12:30:35 per day</b><br> 35 30 12 * * * or 35 30 12<br>" +
        "<b>Default</b><br>" +
        "minute default 0 if leave blank<br>" +
        "hour,day,month,year default * if leave blank<br>" +
        "default cron time is per hour if whole text leave blank"
    });


    //add schedule
    function add_schedule() {
        var schedules = new Array();
        var hosts = new Array();
        $("#host :selected").each(function (i, selected) {
            hosts.push($(selected).text());
        });
        var name = $("#name").val();
        var password = $("#password").val();
        var repos_name = $("#repos option:selected").text();
        var branch = $("#branch option:selected").text();
        var file_path = $("#file option:selected").text();
        var schedule_type = $("#device_type option:selected").text();
        var schedule_name = $("#add_schedule_name").val();
        var schedule_cron_time = $("#add_cron_time").val();
        var schedule_module = $("#add_module option:selected").val();
        if (hosts.length == 0) {
            alert("No Hosts")
        } else if ($("#repos option:selected").val() == "0" || $("#add_module option:selected").val() == "-1" || $("#branch option:selected").val() == "-1" || $("#file option:selected").val() == "-1") {
            alert("Form Error");
        } else {

            for (var i = 0; i < hosts.length; i++) {
                var schedule_json = JSON.stringify({
                    "repos_name": repos_name,
                    "branch": branch,
                    "device_ip": hosts[i],
                    "schedule_name": schedule_name,
                    "cron_time": schedule_cron_time,
                    "enabled": true,
                    "user": {
                        "name": name,
                        "password": password
                    },
                    "file_path": file_path,
                    "type": schedule_type,
                    "module": schedule_module
                });
                schedules.push(schedule_json);
            }

            var post_json = JSON.stringify({
                "schedules": schedules
            });
            $.ajax({
                type: "POST",
                url: "/api/v1/schedules",
                data: post_json,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.status == "0") {
                        $("#add_schedule_field").hide();
                        format_schedules_table();
                    } else if (data.status == "1") {
                        alert("Schedule Name Conflict");
                    } else if (data.status == "-1") {
                        alert(data.msg);
                    }

                },
                error: function (data) {
                    alert(data);
                }
            });
        }
    }

    // update schedule
    function update_schedule() {
        var name = $("#update_user_name").val();
        var password = $("#update_user_password").val();
        var cron_time = $("#update_cron_time").val();
        var enabled = true;
        if ($("#update_enabled option:selected").val() == "disabled") {
            enabled = false;
        }
        var schedules = new Array();
        var schedule_json = JSON.stringify({
            "repos_name": update_repos_name,
            "branch": update_branch,
            "device_ip": update_device_ip,
            "cron_time": cron_time,
            "enabled": enabled,
            "user": {
                "name": name,
                "password": password
            },
            "file_path": update_file_path,
            "type": update_schedule_type,
            "module": update_schedule_module,
            "schedule_name": update_schedule_name
        });
        schedules.push(schedule_json);
        var post_json = JSON.stringify({
            "schedules": schedules
        });
        $.ajax({
            type: "PATCH",
            url: "/api/v1/schedules",
            data: post_json,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.status == 0) {
                    $("#modal_update_schedule").modal("hide");
                    format_schedules_table();
                } else if (data.status == -1) {
                    alert(data.msg);
                }

            },
            error: function (data) {
                alert(data);
            }
        });

    }

    // Delete Device
    function delete_schedule() {
        $.ajax({
            type: "DELETE",
            url: "/api/v1/schedules?key=" + update_schedule_id,
            async: false,
            success: function (data) {
                if (data.status == "1") {
                    alert("No Such Key")
                } else {
                    format_schedules_table();
                }
                $("#modal_update_schedule").modal("hide");
            }
        });
    }

    function format_schedules_table() {

        var table = $('#schedules_table');
        table.dataTable().fnDestroy();
        table.dataTable({
            PaginationType: "full_numbers",
            sort: true,
            processing: true,
            serverSide: false,
            paging: true,
            lengthChange: true,
            searching: true,
            ordering: true,
            info: true,
            autoWidth: false,
            dataType: 'json',
            contentType: "application/json;charset=utf-8",
            ajax: {
                url: "/api/v1/schedules?format=table"
            },
            columns: [
                {"data": "device_ip"},
                {"data": "schedule_name"},
                {"data": "type"},
                {"data": "file_path"},
                {"data": "last_run_time"},
                {"data": "last_success"},
                {"data": "cron_time"},
                {"data": "enabled"}
            ]
        });
        // Table Selected
        $('#schedules_table tbody').on("click", "tr", function () {
            if ($(this).hasClass("selected")) {
                $(this).removeClass("selected");
            }
            else {
                table.$("tr.selected").removeClass("selected");
                $(this).addClass("selected");

                var user_name = "";
                var password = "";
                var cron_time = "";

                var nTrs = table.dataTable().fnGetNodes();//fnGetNodes获取表格所有行，nTrs[i]表示第i行tr
                for (var i = 0; i < nTrs.length; i++) {
                    if ($(nTrs[i]).hasClass("selected")) {
                        var t = table.dataTable().fnGetData(nTrs[i]);
                        update_branch = t["branch"];
                        update_device_ip = t["device_ip"];
                        update_repos_name = t["repos_name"];
                        update_file_path = t["file_path"];
                        update_schedule_module = t["module"];
                        update_schedule_type = t["type"];
                        update_schedule_name = t["schedule_name"];
                        update_enabled = t["enabled"];

                        update_schedule_id = t["id"];
                        user_name = t["user"]["name"];
                        password = t["user"]["password"];
                        cron_time = t["cron_time"];
                        break;
                    }
                }
                $("#update_schedule_id").val(update_schedule_id);
                $("#update_user_name").val(user_name);
                $("#update_user_password").val(password);
                $("#update_cron_time").val(cron_time);

                if (update_enabled == true) {
                    $("#update_enabled").val("enabled");
                } else {
                    $("#update_enabled").val("disabled");
                }

                $("#modal_update_schedule").modal({backdrop: 'static'});
                $("#modal_update_schedule").modal("show");
            }
        });
    }

    function format_schedule_table(url) {

        var table = $('#schedule_table');
        table.dataTable().fnDestroy();
        table.dataTable({
            PaginationType: "full_numbers",
            sort: true,
            processing: true,
            serverSide: false,
            lengthMenu: [[5, 10, 20, -1], [5, 10, 20, "All"]],
            paging: true,
            lengthChange: true,
            searching: true,
            ordering: true,
            order: [[0, "desc"]],
            info: true,
            autoWidth: false,
            dataType: 'json',
            contentType: "application/json;charset=utf-8",
            ajax: {
                url: url
            },
            columns: [
                {"data": "last_run_time"},
                {"data": "next_run_time"},
                {"data": "last_success"}
            ]
        });
        // Table Selected
        $('#schedule_table tbody').on("click", "tr", function () {
            if ($(this).hasClass("selected")) {
                $(this).removeClass("selected");
            }
            else {
                table.$("tr.selected").removeClass("selected");
                $(this).addClass("selected");

                var history = "";

                var nTrs = table.dataTable().fnGetNodes();//fnGetNodes获取表格所有行，nTrs[i]表示第i行tr
                for (var i = 0; i < nTrs.length; i++) {
                    if ($(nTrs[i]).hasClass("selected")) {
                        var t = table.dataTable().fnGetData(nTrs[i]);
                        history = t["msg"];
                        break;
                    }
                }
                $("#history").val(history);
                $("#modal_schedule_history").modal({backdrop: 'static'});
                $("#modal_schedule_historys").modal("show");
            }
        });
    }

    function get_hosts(device_type) {
        $("#host").multiSelect();
        $("#host").empty().multiSelect('refresh');
        $.ajax({
            type: "GET",
            url: "/api/v1/devices/" + device_type,
            async: false,
            success: function (data) {
                for (var i = 0; i < data.msg.length; i++) {
                    console.log(data.msg[i]['ip']);
                    $("#host").multiSelect('addOption', {value: data.msg[i]['ip'], text: data.msg[i]['ip'], index: i});
                }
            },
            error: function (data) {
                alert(data);
            }
        });
    }

    function get_device_types() {
        var dt = $("#device_type");
        $.ajax({
            type: "GET",
            url: "/api/v1/device/keys?search_type=device_type",
            success: function (data) {
                if (data.status == "1") {
                    alert("Get Device Type Failed")
                } else {
                    dt.empty();
                    dt.append("<option selected='selected'  value=-1>Select Device Type</option>");
                    for (var i = 0; i < data.msg.length; i++) {
                        dt.append("<option value=" + i + ">" + data.msg[i] + "</option>");
                    }
                }

            }
        });
    }


    function show_add_schedule() {
        $("#add_schedule_field").show();
        get_device_types();
        // get repository
        GetRepository($("#repos"));

    }
</script>
</body>
</html>

